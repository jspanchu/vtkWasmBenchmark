<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
</head>

<body>
  <canvas id="canvas" style="position: absolute; left: 0; top: 0;"></canvas>
  <script type="text/javascript" src="CompositePolyDataMapper.js"></script>
  <script type='module'>
    var Module = {
      canvas: (function () {
        var canvas = document.getElementById('canvas');
        canvas.addEventListener(
          "webglcontextlost",
          function (e) {
            console.error('WebGL context lost. You will need to reload the page.');
            e.preventDefault();
          },
          false
        );
        return canvas;
      })(),
      print: (text) => { console.log('stdout: ' + text); },
      printErr: (text) => { console.log('stderr: ' + text); },
    };

    // copied from vtk.js/Rendering/Misc/FullScreenRenderWindow.js
    function applyStyle(el, style) {
      Object.keys(style).forEach((key) => {
        el.style[key] = style[key];
      });
    }
    // Use the export name to instantiate the app
    var app = null;
    // -----------------------------------------------------------
    // UI control handling
    // -----------------------------------------------------------
    // copied from vtk.js/Rendering/Misc/FullScreenRenderWindow.js

    // define representation default settings here.
    let lineWidth = 1;
    let pointSize = 1;
    let nx = 8;
    let ny = 8;

    const STYLE_CONTROL_PANEL = {
      position: 'absolute',
      left: '25px',
      top: '25px',
      backgroundColor: 'white',
      borderRadius: '5px',
      listStyle: 'none',
      padding: '5px 10px',
      margin: '0',
      display: 'block',
      border: 'solid 1px black',
      maxWidth: 'calc(100% - 70px)',
      maxHeight: 'calc(100% - 60px)',
      overflow: 'auto',
    };
    let controlContainer = document.createElement('div');
    applyStyle(
      controlContainer,
      STYLE_CONTROL_PANEL
    );
    const body = document.querySelector('body');
    body.appendChild(controlContainer);
    const controller = `
<table>
  <tr>
    <td>
      <select class='representations' style="width: 100%">
        <option value='0'>Points</option>
        <option value='1'>Wireframe</option>
        <option value='2'>Surface</option>
        <option value='3' selected>Surface With Edges</option>
      </select>
    </td>
  </tr>
  <tr id='lw_row' style='display: none;'>
    <td>Line width (Surface with edges)</td>
    <td>
      <input class='lw' type='range' min='1' max='20' value='${lineWidth}' oninput='this.nextElementSibling.value = this.value'>
      <output>${lineWidth}</output>
    </td>
  </tr>
  <tr id='ps_row' style='display: none;'>
    <td>Point size (Points)</td>
    <td>
      <input class='ps' type='range' min='1' max='20' value='${pointSize}' oninput='this.nextElementSibling.value = this.value'>
      <output>${pointSize}</output>
    </td>
  </tr>
  <tr>
    <td>Pick blocks</td>
    <td>
      <input type='checkbox' class='pickBlocks'>
    </td>
  </tr>
  <tr>
    <td>nx </td>
    <td>
      <input class='nx' type='range' min='2' max='32' value='${nx}' oninput="this.nextElementSibling.value = this.value">
      <output>${nx}</output>
    </td>
  </tr>
  <tr>
    <td>ny </td>
    <td>
      <input class='ny' type='range' min='2' max='32' value='${ny}' oninput="this.nextElementSibling.value = this.value">
      <output>${ny}</output>
    </td>
  </tr>
  <td>
    <button class='resetviewbutton' style="width: 100%">Reset View</button>
  </td>
</table>`
    controlContainer.innerHTML = controller;
    controlContainer.style.display = 'block';

    document
      .querySelector('.representations')
      .addEventListener('change', (e) => {
        const newRepValue = Number(e.target.value);
        app.setRepresentation(newRepValue);
        updatePropertyWidgets();
      });
    document
      .querySelector('.lw')
      .addEventListener('input', (e) => {
        lineWidth = Number(e.target.value);
        app.setLineWidth(lineWidth);
      });
    document
      .querySelector('.ps')
      .addEventListener('input', (e) => {
        pointSize = Number(e.target.value);
        app.setPointSize(pointSize);
      });
    document
      .querySelector('.pickBlocks')
      .addEventListener('change', () => {
        const pickEnabled = document.querySelector('.pickBlocks').checked;
        app.setPicking(pickEnabled);
      });
    document
      .querySelector('.nx')
      .addEventListener('input', () => {
        updateDatasets();
      });
    document
      .querySelector('.ny')
      .addEventListener('input', () => {
        updateDatasets();
      });
    document
      .querySelector('.resetviewbutton')
      .addEventListener('click', (e) => {
        app.resetView();
      });

    function updatePropertyWidgets() {
      const newRepValue = Number(document.querySelector('.representations').value);
      document.getElementById('ps_row').style.display = 'none';
      document.getElementById('lw_row').style.display = 'none';
      if (newRepValue === 0) {
        document.getElementById('ps_row').style.display = 'table-row';
      }
      if (newRepValue === 3) {
        document.getElementById('lw_row').style.display = 'table-row';
      }
    }

    function updateDatasets() {
      nx = Number(document.querySelector('.nx').value);
      ny = Number(document.querySelector('.ny').value);
      app.createDatasets(nx, ny)
      app.resetView();
    }

    function updateRepresentation() {
      const newLineWidth = Number(document.querySelector('.lw').value);
      const pickEnabled = document.querySelector('.pickBlocks').checked;
      const newPointSize = Number(document.querySelector('.ps').value);
      const newRepValue = Number(document.querySelector('.representations').value);
      app.setLineWidth(newLineWidth);
      app.setPicking(pickEnabled);
      app.setPointSize(newPointSize);
      app.setRepresentation(newRepValue);
      updatePropertyWidgets();
    }

    vtkCPDMApp(Module).then(module => {
      app = module;
      console.log('App created');
      // -----------------------------------------------------------
      // Initialize application with nx, ny
      // -----------------------------------------------------------
      app.initialize();
      updateDatasets();
      updateRepresentation();
      // sends a resize event so that the render window fills up browser tab dimensions.
      setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
      }, 0);
      app.run();
    })
  </script>
</body>

</html>