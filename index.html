<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
</head>

<body>
  <canvas id="canvas" style="position: absolute; left: 0; top: 0;"></canvas>
  <script type="text/javascript" src="CompositePolyDataMapper.js"></script>
  <script type='module'>
    var Module = {
      canvas: (function () {
        var canvas = document.getElementById('canvas');
        canvas.addEventListener(
          "webglcontextlost",
          function (e) {
            console.error('WebGL context lost. You will need to reload the page.');
            e.preventDefault();
          },
          false
        );
        return canvas;
      })(),
      print: (text) => { console.log('stdout: ' + text); },
      printErr: (text) => { console.log('stderr: ' + text); },
    };

    // -----------------------------------------------------------
    // Helpers
    // -----------------------------------------------------------
    // copied from vtk.js/Rendering/Misc/FullScreenRenderWindow.js
    function applyStyle(el, style) {
      Object.keys(style).forEach((key) => {
        el.style[key] = style[key];
      });
    }
    // Converts the HTML color picker value into usable RGB
    function hexToRGB(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result
        ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16),
        }
        : null;
    }

    // define representation default settings here.
    let lineWidth = 1;
    let pointSize = 1;
    let layer0Visibility = true; // cones
    let layer1Visibility = true; // spheres
    let layer2Visibility = true; // cylinders
    let nx = 8;
    let ny = 8;

    // -----------------------------------------------------------
    // UI control handling
    // -----------------------------------------------------------
    // copied from vtk.js/Rendering/Misc/FullScreenRenderWindow.js
    const STYLE_CONTROL_PANEL = {
      position: 'absolute',
      left: '25px',
      top: '25px',
      backgroundColor: 'white',
      borderRadius: '5px',
      listStyle: 'none',
      padding: '5px 10px',
      margin: '0',
      display: 'block',
      border: 'solid 1px black',
      maxWidth: 'calc(100% - 70px)',
      maxHeight: 'calc(100% - 60px)',
      overflow: 'auto',
    };
    let controlContainer = document.createElement('div');
    applyStyle(
      controlContainer,
      STYLE_CONTROL_PANEL
    );
    const body = document.querySelector('body');
    body.appendChild(controlContainer);
    const controller = `
<table>
  <tr>
    <td>
      <select class='representations' style="width: 100%">
        <option value='0'>Points</option>
        <option value='1'>Wireframe</option>
        <option value='2'>Surface</option>
        <option value='3' selected>Surface With Edges</option>
      </select>
    </td>
  </tr>
  <tr id='lw_row' style='display: none;'>
    <td>Line width (Surface with edges)</td>
    <td>
      <input class='lw' type='range' min='1' max='20' value='${lineWidth}' oninput='this.nextElementSibling.value = this.value'>
      <output>${lineWidth}</output>
    </td>
    <td>
      <label>Color: </label>
      <input class='edgeColor' type='color', value='#FFFFFF'/>
    </td>
  </tr>
  <tr id='ps_row' style='display: none;'>
    <td>Point size (Points)</td>
    <td>
      <input class='ps' type='range' min='1' max='20' value='${pointSize}' oninput='this.nextElementSibling.value = this.value'>
      <output>${pointSize}</output>
    </td>
  </tr>
  <tr>
    <td>Selector type</td>
    <td>
      <select class='pickerType' style="width: 100%">
        <option value='0' selected>Hover Pre-select</option>
        <option value='1'>Area Picker ('r' toggles rubberband)</option>
      </select>
    </td>
    <tr id='selection_color_row' style='display: none;'>
      <td>
        <label>Selected Block Color: </label>
        <input class='selectionColor' type='color', value='#FFF00F'/>
      </td>
    </tr>
  </tr>
  <tr>
    <td>Layer 0 (Cones)</td>
    <td>
      <input type='checkbox' class='layer0Visibility' checked='${layer0Visibility}'>
    </td>
  </tr>
  <tr>
    <td>Layer 1 (Spheres)</td>
    <td>
      <input type='checkbox' class='layer1Visibility' checked='${layer1Visibility}'>
    </td>
  </tr>
  <tr>
    <td>Layer 2 (Cylinders)</td>
    <td>
      <input type='checkbox' class='layer2Visibility' checked='${layer2Visibility}'>
    </td>
  </tr>
  <tr>
    <td>nx </td>
    <td>
      <input class='nx' type='range' min='2' max='32' value='${nx}' oninput="this.nextElementSibling.value = this.value">
      <output>${nx}</output>
    </td>
  </tr>
  <tr>
    <td>ny </td>
    <td>
      <input class='ny' type='range' min='2' max='32' value='${ny}' oninput="this.nextElementSibling.value = this.value">
      <output>${ny}</output>
    </td>
  </tr>
  <td>
    <button class='resetviewbutton' style="width: 100%">Reset View</button>
  </td>
</table>`
    controlContainer.innerHTML = controller;
    controlContainer.style.display = 'block';

    // Use the export name to instantiate the app
    var app = null;
    document
      .querySelector('.representations')
      .addEventListener('change', (e) => {
        const newRepValue = Number(e.target.value);
        app.setRepresentation(newRepValue);
        updatePropertyWidgets();
      });
    document
      .querySelector('.lw')
      .addEventListener('input', (e) => {
        lineWidth = Number(e.target.value);
        app.setLineWidth(lineWidth);
      });
    document
      .querySelector('.edgeColor').addEventListener('input', (e) => {
        const color = hexToRGB(e.target.value);
        app.setEdgeColor(color.r / 255.0, color.g / 255.0, color.b / 255.0);
      });
    document
      .querySelector('.ps')
      .addEventListener('input', (e) => {
        pointSize = Number(e.target.value);
        app.setPointSize(pointSize);
      });
    document
      .querySelector('.pickerType')
      .addEventListener('change', () => {
        updatePickers();
      });
    document
      .querySelector('.selectionColor').addEventListener('input', (e) => {
        const color = hexToRGB(e.target.value);
        app.setSelectedBlockColor(color.r / 255.0, color.g / 255.0, color.b / 255.0);
      });
    document
      .querySelector('.layer0Visibility')
      .addEventListener('change', () => {
        layer0Visibility = document.querySelector('.layer0Visibility').checked;
        app.setLayerVisibility(0, layer0Visibility);
      });
    document
      .querySelector('.layer1Visibility')
      .addEventListener('change', () => {
        layer1Visibility = document.querySelector('.layer1Visibility').checked;
        app.setLayerVisibility(1, layer1Visibility);
      });
    document
      .querySelector('.layer2Visibility')
      .addEventListener('change', () => {
        layer2Visibility = document.querySelector('.layer2Visibility').checked;
        app.setLayerVisibility(2, layer2Visibility);
      });
    document
      .querySelector('.nx')
      .addEventListener('input', () => {
        updateDatasets();
      });
    document
      .querySelector('.ny')
      .addEventListener('input', () => {
        updateDatasets();
      });
    document
      .querySelector('.resetviewbutton')
      .addEventListener('click', () => {
        app.resetView();
      });

    function updatePropertyWidgets() {
      const newRepValue = Number(document.querySelector('.representations').value);
      document.getElementById('ps_row').style.display = 'none';
      document.getElementById('lw_row').style.display = 'none';
      if (newRepValue === 0) {
        document.getElementById('ps_row').style.display = 'table-row';
      }
      if (newRepValue === 3) {
        document.getElementById('lw_row').style.display = 'table-row';
      }
    }

    function updatePickers() {
      const newPickerType = Number(document.querySelector('.pickerType').value);
      if (newPickerType === 0) {
        app.setAreaPick(false);
        app.setHoverPreSelect(true);
        document.getElementById('selection_color_row').style.display = 'none';
      }
      else if (newPickerType === 1) {
        app.setHoverPreSelect(false);
        app.setAreaPick(true);
        document.getElementById('selection_color_row').style.display = 'table-row';
      }
    }

    function updateDatasets() {
      nx = Number(document.querySelector('.nx').value);
      ny = Number(document.querySelector('.ny').value);
      app.createDatasets(nx, ny)
      app.resetView();
    }

    function updateRepresentation() {
      const color = hexToRGB(document.querySelector('.edgeColor').value);
      const newLineWidth = Number(document.querySelector('.lw').value);
      const newPointSize = Number(document.querySelector('.ps').value);
      const newRepValue = Number(document.querySelector('.representations').value);
      app.setEdgeColor(color.r / 255.0, color.g / 255.0, color.b / 255.0);
      app.setLineWidth(newLineWidth);
      app.setPointSize(newPointSize);
      app.setRepresentation(newRepValue);
      updatePropertyWidgets();
    }

    vtkCPDMApp(Module).then(module => {
      app = module;
      console.log('App created');
      // -----------------------------------------------------------
      // Initialize application with nx, ny
      // -----------------------------------------------------------
      app.initialize();
      updateDatasets();
      updateRepresentation();
      updatePickers();
      // sends a resize event so that the render window fills up browser tab dimensions.
      setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
      }, 0);
      // focus on the canvas to grab keyboard inputs.
      canvas.setAttribute('tabindex', '0');
      // grab focus when the render window region receives mouse clicks.
      canvas.addEventListener('click', () => canvas.focus());
      // starts processing events on browser main thread.
      app.run();
    })
  </script>
</body>

</html>